<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{/Layout/Head}">
    <title>Thanh toán</title>
</head>
<head>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.css" rel="stylesheet">
    <style>
        .transition-all {
            transition: all 0.3s ease;
        }
    
        .transition-all:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1) !important;
        }
    
        .transition-hover {
            transition: all 0.2s ease;
        }
    
        .transition-hover:hover {
            transform: scale(1.02);
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
    
        .transition-btn {
            transition: all 0.3s ease;
        }
    
        .transition-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255,193,7,0.4);
            background-color: #ffca2c;
        }

        .checkout-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            position: relative;
        }

        .checkout-steps::before {
            content: '';
            position: absolute;
            top: 24px;
            left: 0;
            right: 0;
            height: 2px;
            background-color: #e9ecef;
            z-index: 1;
        }

        .step {
            position: relative;
            z-index: 2;
            background-color: white;
            padding: 0 15px;
            text-align: center;
        }

        .step-number {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #e9ecef;
            color: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .step.active .step-number {
            background-color: #ffc107;
            color: white;
        }

        .step.completed .step-number {
            background-color: #28a745;
            color: white;
        }

        .payment-method {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .payment-method:hover {
            border-color: #ffc107;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        .payment-method.selected {
            border-color: #ffc107;
            background-color: rgba(255, 193, 7, 0.1);
        }

        .address-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .address-card:hover {
            border-color: #ffc107;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        .address-card.selected {
            border-color: #ffc107;
            background-color: rgba(255, 193, 7, 0.1);
        }

        .order-summary-item {
            display: flex;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #f1f1f1;
        }

        .order-summary-item:last-child {
            border-bottom: none;
        }

        .item-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            margin-right: 15px;
        }

        .item-details {
            flex: 1;
        }

        .item-price {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .item-quantity {
            font-size: 0.9rem;
            color: #6c757d;
        }

        .item-total {
            font-weight: bold;
            color: #212529;
        }

        .form-check-input:checked {
            background-color: #ffc107;
            border-color: #ffc107;
        }
        
        /* CSS cho phần mã giảm giá */
        .coupon-section {
            margin-top: 15px;
            margin-bottom: 15px;
        }
        
        .coupon-input {
            display: flex;
            margin-bottom: 10px;
        }
        
        .coupon-success {
            background-color: rgba(40, 167, 69, 0.1);
            border-radius: 5px;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            margin-top: 10px;
        }
        
        .coupon-error {
            background-color: rgba(220, 53, 69, 0.1);
            border-radius: 5px;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            margin-top: 10px;
        }
        
        .btn-apply-coupon {
            background-color: #ffc107;
            color: #212529;
            border: none;
            transition: all 0.3s;
        }
        
        .btn-apply-coupon:hover {
            background-color: #ffca2c;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255,193,7,0.4);
        }
        
        .btn-remove-coupon {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            margin-left: auto;
            padding: 0;
            font-size: 16px;
        }
        
        /* Voucher card styles */
        .voucher-select {
            position: relative;
            width: 100%;
        }
        
        .voucher-option {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 10px 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .voucher-option:hover {
            border-color: #ffc107;
            background-color: rgba(255, 193, 7, 0.05);
        }
        
        .voucher-option.selected {
            border-color: #ffc107;
            background-color: rgba(255, 193, 7, 0.1);
        }
        
        .voucher-code {
            font-weight: 600;
            color: #212529;
        }
        
        .voucher-discount {
            color: #dc3545;
            font-weight: 600;
        }
        
        .voucher-description {
            font-size: 0.85rem;
            color: #6c757d;
            margin-top: 5px;
        }
        
        .voucher-expiry {
            font-size: 0.8rem;
            color: #6c757d;
        }
        
        .voucher-min-order {
            font-size: 0.8rem;
            color: #6c757d;
            margin-top: 2px;
        }
        
        .no-vouchers {
            text-align: center;
            padding: 15px;
            color: #6c757d;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px dashed #dee2e6;
        }
        
        /* Shipping time info styles */
        .shipping-time-info {
            background-color: #f0f8ff;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            border-left: 4px solid #007bff;
        }
        
        .delivery-estimate {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .delivery-estimate i {
            color: #ffc107;
            margin-right: 10px;
            font-size: 1.2rem;
        }
        
        .delivery-date {
            font-weight: 600;
            color: #007bff;
        }
        
        .delivery-range {
            color: #6c757d;
            font-size: 0.9rem;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div th:replace="~{/Layout/Navbar}"></div>

    <div class="container-fluid py-5 mt-5 pt-5">
        <!-- Login Required Message -->
        <div class="row" th:if="${loginMessage != null}">
            <div class="col-12">
                <div class="alert alert-warning text-center">
                    <i class="fa-solid fa-circle-exclamation me-2"></i>
                    <span th:text="${loginMessage}">Vui lòng đăng nhập để tiếp tục thanh toán</span>
                    <a th:href="@{/login}" class="btn btn-sm btn-primary ms-3">Đăng nhập ngay</a>
                </div>
            </div>
        </div>

        <!-- Checkout Content - Only show if user is logged in -->
        <div class="row" th:if="${loginMessage == null}">
            <div class="col-12 mb-4">
                <div class="checkout-steps">
                    <div class="step completed">
                        <div class="step-number">1</div>
                        <div class="step-title">Giỏ hàng</div>
                    </div>
                    <div class="step active">
                        <div class="step-number">2</div>
                        <div class="step-title">Thanh toán</div>
                    </div>
                    <div class="step">
                        <div class="step-number">3</div>
                        <div class="step-title">Hoàn tất</div>
                    </div>
                </div>
            </div>

            <div class="col-lg-8 col-12 pe-lg-4">
                <!-- Shipping Address Section -->
                <div class="border border-1 p-4 rounded-3 mb-4 bg-white shadow-sm">
                    <h5 class="fw-bold mb-3">
                        <i class="fa-solid fa-location-dot me-2 text-warning"></i>
                        Địa chỉ giao hàng
                    </h5>

                    <div class="mb-3">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" name="addressOption" id="useProfileAddress" checked>
                            <label class="form-check-label" for="useProfileAddress">
                                Sử dụng địa chỉ từ hồ sơ
                            </label>
                        </div>
                        
                        <div id="profileAddressCard" class="address-card selected ms-4">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="mb-1" th:text="${fullname}">Tên người dùng</h6>
                                    <p class="mb-1" th:text="${phone}">Số điện thoại</p>
                                    <p class="mb-0 text-muted" th:text="${address} + ', ' + ${ward} + ', ' + ${district} + ', ' + ${province}">
                                        Địa chỉ chi tiết, Phường/Xã, Quận/Huyện, Tỉnh/Thành phố
                                    </p>
                                </div>
                                <div>
                                    <span class="badge bg-success">Mặc định</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Thêm thông tin thời gian giao hàng cho địa chỉ mặc định -->
                        <div id="profileShippingTimeInfo" class="shipping-time-info ms-4 mt-3" th:if="${province != null && !province.isEmpty()}">
                            <div class="delivery-estimate">
                                <i class="fa-solid fa-truck"></i>
                                <div>
                                    <strong>Thời gian giao hàng dự kiến:</strong> 
                                    <span class="delivery-date" th:if="${deliveryTimeRange != null}" th:text="${deliveryTimeRange}">3-4 ngày</span>
                                </div>
                            </div>
                            <div class="delivery-range">
                                <i class="fa-solid fa-info-circle me-1"></i>
                                Đơn hàng sẽ được giao đến <span th:text="${province}">Tỉnh/Thành phố</span> 
                                trong khoảng <span th:text="${deliveryTimeRange}">3-4 ngày</span> kể từ khi đặt hàng
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" name="addressOption" id="useNewAddress">
                            <label class="form-check-label" for="useNewAddress">
                                Sử dụng địa chỉ mới
                            </label>
                        </div>
                        
                        <div id="newAddressForm" class="ms-4 d-none">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Họ và tên</label>
                                    <input type="text" class="form-control" id="newName" placeholder="Nhập họ và tên">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Số điện thoại</label>
                                    <input type="tel" class="form-control" id="newPhone" placeholder="Nhập số điện thoại">
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label class="form-label">Tỉnh/Thành phố</label>
                                    <select class="form-select" id="newProvince">
                                        <option value="">Chọn tỉnh/thành phố</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Quận/Huyện</label>
                                    <select class="form-select" id="newDistrict">
                                        <option value="">Chọn quận/huyện</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Phường/Xã</label>
                                    <select class="form-select" id="newWard">
                                        <option value="">Chọn phường/xã</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Địa chỉ chi tiết</label>
                                <input type="text" class="form-control" id="newAddressDetail" placeholder="Số nhà, tên đường, khu vực...">
                            </div>
                            
                            <!-- Thêm thông tin thời gian giao hàng cho địa chỉ mới -->
                            <div id="newAddressShippingTimeInfo" class="shipping-time-info d-none">
                                <div class="delivery-estimate">
                                    <i class="fa-solid fa-truck"></i>
                                    <div>
                                        <strong>Thời gian giao hàng dự kiến:</strong> 
                                        <span id="newAddressDeliveryTime">Chọn tỉnh/thành phố để xem thời gian giao hàng</span>
                                    </div>
                                </div>
                                <div class="delivery-range" id="newAddressDeliveryRange">
                                    <i class="fa-solid fa-info-circle me-1"></i>
                                    Vui lòng chọn tỉnh/thành phố để xem thông tin giao hàng
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payment Method Section -->
                <div class="border border-1 p-4 rounded-3 mb-4 bg-white shadow-sm">
                    <h5 class="fw-bold mb-3">
                        <i class="fa-solid fa-credit-card me-2 text-warning"></i>
                        Phương thức thanh toán
                    </h5>

                    <div class="payment-method selected" data-method="codPayment">
                        <div class="d-flex align-items-center">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="codPayment" checked>
                                <label class="form-check-label" for="codPayment">
                                    <strong>Thanh toán khi nhận hàng (COD)</strong>
                                </label>
                            </div>
                            <div class="ms-auto">
                                <i class="fa-solid fa-money-bill-wave fa-lg text-success"></i>
                            </div>
                        </div>
                        <div class="ms-4 mt-2 text-muted small">
                            Bạn sẽ thanh toán bằng tiền mặt khi nhận hàng
                        </div>
                    </div>

                    <div class="payment-method mt-3" data-method="bankPayment">
                        <div class="d-flex align-items-center">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="bankPayment">
                                <label class="form-check-label" for="bankPayment">
                                    <strong>Chuyển khoản ngân hàng</strong>
                                </label>
                            </div>
                            <div class="ms-auto">
                                <i class="fa-solid fa-building-columns fa-lg text-primary"></i>
                            </div>
                        </div>
                        <div class="ms-4 mt-2 text-muted small">
                            Thực hiện thanh toán vào ngay tài khoản ngân hàng của chúng tôi. Vui lòng sử dụng Mã đơn hàng của bạn trong phần Nội dung thanh toán. Đơn hàng sẽ đươc giao sau khi tiền đã chuyển.
                        </div>
                    </div>

                    <div class="payment-method mt-3" data-method="momoPayment">
                        <div class="d-flex align-items-center">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="momoPayment">
                                <label class="form-check-label" for="momoPayment">
                                    <strong>Thanh toán MoMo</strong>
                                </label>
                            </div>
                            <div class="ms-auto">
                                <i class="fa-solid fa-wallet fa-lg text-danger"></i>
                            </div>
                        </div>
                        <div class="ms-4 mt-2 text-muted small">
                            Thanh toán qua ví điện tử MoMo
                        </div>
                    </div>
                </div>
                
                <!-- Voucher Selection Section -->
                <div class="border border-1 p-4 rounded-3 mb-4 bg-white shadow-sm">
                    <h5 class="fw-bold mb-3">
                        <i class="fa-solid fa-ticket-alt me-2 text-warning"></i>
                        Mã giảm giá
                    </h5>
                    
                    <div class="voucher-select">
                        <!-- Dropdown để chọn voucher -->
                        <select class="form-select mb-3" id="voucherSelect">
                            <option value="">-- Chọn mã giảm giá --</option>
                            <option th:each="voucher : ${availableVouchers}" 
                                    th:value="${voucher.code}" 
                                    th:text="${voucher.code + ' - Giảm ' + #numbers.formatDecimal(voucher.discountAmount, 0, 'COMMA', 0, 'POINT') + '₫'}"
                                    th:data-discount="${voucher.discountAmount}"
                                    th:data-min-order="${voucher.minimumOrderAmount}">
                                WELCOME10 - Giảm 50,000₫
                            </option>
                        </select>
                        
                        <!-- Hiển thị chi tiết voucher đã chọn -->
                        <div id="selectedVoucherDetails" class="d-none">
                            <div class="voucher-option selected">
                                <div>
                                    <div class="voucher-code" id="selectedVoucherCode">WELCOME10</div>
                                    <div class="voucher-description" id="selectedVoucherDescription">
                                        Giảm <span id="selectedVoucherAmount">50,000₫</span> cho đơn hàng
                                    </div>
                                    <div class="voucher-min-order" id="selectedVoucherMinOrder">
                                        Đơn tối thiểu: 200,000₫
                                    </div>
                                </div>
                                <button type="button" class="btn-close" id="removeVoucherBtn" aria-label="Close"></button>
                            </div>
                        </div>
                        
                        <!-- Hiển thị khi không có voucher nào khả dụng -->
                        <div th:if="${#lists.isEmpty(availableVouchers)}" class="no-vouchers">
                            <i class="fa-solid fa-ticket-alt me-2 text-muted"></i>
                            Hiện không có mã giảm giá nào khả dụng
                        </div>
                        
                        <!-- Hiển thị khi voucher không hợp lệ -->
                        <div class="coupon-error d-none" id="voucherError">
                            <i class="fa-solid fa-exclamation-circle text-danger me-2"></i>
                            <span id="voucherErrorMessage">Đơn hàng không đủ điều kiện áp dụng mã giảm giá này</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4 col-12">
                <!-- Order Summary -->
                <div class="border shadow-sm p-4 rounded-3 bg-light transition-all">
                    <h5 class="fw-bold mb-4 text-success position-relative">
                        THÔNG TIN ĐƠN HÀNG
                        <span class="position-absolute bottom-0 start-0 bg-success h-1 w-25 rounded"></span>
                    </h5>
                    
                    <div class="order-items mb-3">
                        <!-- Hiển thị các sản phẩm trong giỏ hàng -->
                        <div th:each="item : ${cartItems}" class="order-summary-item">
                            <img th:src="${item.image}" alt="Product Image" class="item-image">
                            <div class="item-details">
                                <h6 class="mb-1" th:text="${item.name}">Tên sản phẩm</h6>
                                <div class="item-price mb-1" th:text="${#numbers.formatDecimal(item.price, 0, 'COMMA', 0, 'POINT')} + ' ₫'">Giá</div>
                                <div class="d-flex justify-content-between">
                                    <span class="item-quantity" th:text="'SL: ' + ${item.quantity}">SL: 1</span>
                                    <span class="item-total" th:text="${#numbers.formatDecimal(item.totalPrice, 0, 'COMMA', 0, 'POINT')} + ' ₫'">Tổng</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="border-top pt-3 mt-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">Tạm tính</span>
                            <span id="subtotal" class="fw-semibold" th:text="${#numbers.formatDecimal(totalPrice, 0, 'COMMA', 0, 'POINT')} + ' ₫'" th:data-value="${totalPrice}">0 ₫</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">Phí vận chuyển</span>
                            <span id="shippingFee" class="fw-semibold" data-value="30000">30,000 ₫</span>
                        </div>
                        
                        <!-- Hiển thị giảm giá khi áp dụng mã giảm giá thành công -->
                        <div class="d-flex justify-content-between mb-2 d-none" id="discountRow">
                            <span class="text-muted">Giảm giá</span>
                            <span id="discountAmount" class="fw-semibold text-danger">-10,000 ₫</span>
                        </div>
                        
                        <h6 class="d-flex justify-content-between fw-bold mt-3 mb-4 text-dark">
                            <span>Tổng cộng</span>
                            <span id="finalTotal" class="text-success" th:with="total=${totalPrice + 30000}" th:text="${#numbers.formatDecimal(total, 0, 'COMMA', 0, 'POINT')} + ' ₫'">0 ₫</span>
                        </h6>
                    </div>
            
                    <button id="placeOrderBtn" class="btn btn-warning w-100 mt-2 rounded-pill py-2 fw-semibold transition-btn">
                        <i class="fa-solid fa-check-circle me-2"></i>
                        ĐẶT HÀNG
                    </button>

                    <div class="text-center mt-3">
                        <a href="/yourcart" class="text-decoration-none">
                            <i class="fa-solid fa-arrow-left me-1"></i>
                            Quay lại giỏ hàng
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div th:replace="~{/Layout/Footer}"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.js"></script>
    <script>AOS.init();</script>

    <script th:inline="javascript">
        document.addEventListener("DOMContentLoaded", function() {
            // Xử lý chọn địa chỉ
            const useProfileAddress = document.getElementById('useProfileAddress');
            const useNewAddress = document.getElementById('useNewAddress');
            const profileAddressCard = document.getElementById('profileAddressCard');
            const newAddressForm = document.getElementById('newAddressForm');
            const profileShippingTimeInfo = document.getElementById('profileShippingTimeInfo');
            const newAddressShippingTimeInfo = document.getElementById('newAddressShippingTimeInfo');
            const provinceSelect = document.getElementById('newProvince');
            const districtSelect = document.getElementById('newDistrict');
            const wardSelect = document.getElementById('newWard');

            useProfileAddress.addEventListener('change', function() {
                if (this.checked) {
                    profileAddressCard.classList.add('selected');
                    newAddressForm.classList.add('d-none');
                    if (profileShippingTimeInfo) {
                        profileShippingTimeInfo.classList.remove('d-none');
                    }
                    newAddressShippingTimeInfo.classList.add('d-none');
                }
            });

            useNewAddress.addEventListener('change', function() {
                if (this.checked) {
                    profileAddressCard.classList.remove('selected');
                    newAddressForm.classList.remove('d-none');
                    if (profileShippingTimeInfo) {
                        profileShippingTimeInfo.classList.add('d-none');
                    }
                    // Hiển thị thông tin giao hàng cho địa chỉ mới nếu đã chọn tỉnh/thành phố
                    if (provinceSelect.selectedIndex > 0) {
                        newAddressShippingTimeInfo.classList.remove('d-none');
                    }
                }
            });

            // Xử lý chọn phương thức thanh toán
            const paymentMethods = document.querySelectorAll('.payment-method');
            const paymentRadios = document.querySelectorAll('input[name="paymentMethod"]');

            paymentMethods.forEach(method => {
                method.addEventListener('click', function() {
                    // Bỏ chọn tất cả
                    paymentMethods.forEach(m => m.classList.remove('selected'));
                    
                    // Chọn phương thức hiện tại
                    this.classList.add('selected');
                    
                    // Chọn radio button tương ứng
                    const methodType = this.getAttribute('data-method');
                    document.getElementById(methodType).checked = true;
                });
            });

            paymentRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.checked) {
                        // Bỏ chọn tất cả
                        paymentMethods.forEach(m => m.classList.remove('selected'));
                        
                        // Chọn phương thức tương ứng
                        const methodId = this.id;
                        document.querySelector(`.payment-method[data-method="${methodId}"]`).classList.add('selected');
                    }
                });
            });

            // Xử lý API địa chỉ cho form địa chỉ mới
            // Lấy danh sách tỉnh/thành phố từ API
            fetch("https://provinces.open-api.vn/api/p/")
                .then(response => response.json())
                .then(data => {
                    // Thêm các tùy chọn vào dropdown tỉnh/thành phố
                    data.forEach(province => {
                        let option = document.createElement("option");
                        option.value = province.code;
                        option.textContent = province.name;
                        provinceSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error("Lỗi khi lấy danh sách tỉnh/thành phố:", error);
                });

            // Hàm tải danh sách quận/huyện
            function loadDistricts(provinceCode) {
                fetch(`https://provinces.open-api.vn/api/p/${provinceCode}?depth=2`)
                    .then(response => response.json())
                    .then(data => {
                        // Xóa các tùy chọn hiện tại
                        districtSelect.innerHTML = "<option value=''>Chọn quận/huyện</option>";
                        
                        // Thêm các tùy chọn mới
                        data.districts.forEach(district => {
                            let option = document.createElement("option");
                            option.value = district.code;
                            option.textContent = district.name;
                            districtSelect.appendChild(option);
                        });
                    })
                    .catch(error => {
                        console.error("Lỗi khi lấy danh sách quận/huyện:", error);
                    });
            }
            
            // Hàm tải danh sách phường/xã
            function loadWards(districtCode) {
                fetch(`https://provinces.open-api.vn/api/d/${districtCode}?depth=2`)
                    .then(response => response.json())
                    .then(data => {
                        // Xóa các tùy chọn hiện tại
                        wardSelect.innerHTML = "<option value=''>Chọn phường/xã</option>";
                        
                        // Thêm các tùy chọn mới
                        data.wards.forEach(ward => {
                            let option = document.createElement("option");
                            option.value = ward.code;
                            option.textContent = ward.name;
                            wardSelect.appendChild(option);
                        });
                    })
                    .catch(error => {
                        console.error("Lỗi khi lấy danh sách phường/xã:", error);
                    });
            }

            // Sự kiện khi chọn tỉnh/thành phố
            provinceSelect.addEventListener("change", function() {
                const provinceCode = this.value;
                
                // Xóa các tùy chọn quận/huyện và phường/xã
                districtSelect.innerHTML = "<option value=''>Chọn quận/huyện</option>";
                wardSelect.innerHTML = "<option value=''>Chọn phường/xã</option>";
                
                // Nếu đã chọn tỉnh/thành phố, tải danh sách quận/huyện
                if (provinceCode) {
                    loadDistricts(provinceCode);
                    
                    // Cập nhật thông tin thời gian giao hàng
                    updateShippingTimeInfo(this.options[this.selectedIndex].text);
                } else {
                    // Ẩn thông tin thời gian giao hàng nếu không chọn tỉnh/thành phố
                    newAddressShippingTimeInfo.classList.add('d-none');
                }
            });
            
            // Sự kiện khi chọn quận/huyện
            districtSelect.addEventListener("change", function() {
                const districtCode = this.value;
                
                // Xóa các tùy chọn phường/xã
                wardSelect.innerHTML = "<option value=''>Chọn phường/xã</option>";
                
                // Nếu đã chọn quận/huyện, tải danh sách phường/xã
                if (districtCode) {
                    loadWards(districtCode);
                }
            });
            
            // Hàm cập nhật thông tin thời gian giao hàng
            function updateShippingTimeInfo(province) {
                if (!province) return;
                
                // Gọi API để lấy thông tin thời gian giao hàng
                fetch(`/api/shipping/estimate?province=${encodeURIComponent(province)}`)
                    .then(response => response.json())
                    .then(data => {
                        // Hiển thị thông tin thời gian giao hàng
                        const newAddressDeliveryTime = document.getElementById('newAddressDeliveryTime');
                        const newAddressDeliveryRange = document.getElementById('newAddressDeliveryRange');
                        
                        if (data.estimatedDeliveryDate) {
                            const deliveryDate = new Date(data.estimatedDeliveryDate);
                            const formattedDate = deliveryDate.toLocaleDateString('vi-VN', {
                                day: '2-digit',
                                month: '2-digit',
                                year: 'numeric'
                            });
                            
                            newAddressDeliveryTime.textContent = formattedDate;
                            newAddressDeliveryRange.innerHTML = `
                                <i class="fa-solid fa-info-circle me-1"></i>
                                Đơn hàng sẽ được giao đến <strong>${province}</strong> 
                                trong khoảng <strong>${data.deliveryTimeRange}</strong> kể từ khi đặt hàng
                            `;
                            
                            // Hiển thị thông tin thời gian giao hàng
                            newAddressShippingTimeInfo.classList.remove('d-none');
                        }
                    })
                    .catch(error => {
                        console.error('Lỗi khi lấy thông tin thời gian giao hàng:', error);
                    });
            }
            
            // Xử lý chọn voucher
            const voucherSelect = document.getElementById('voucherSelect');
            const selectedVoucherDetails = document.getElementById('selectedVoucherDetails');
            const selectedVoucherCode = document.getElementById('selectedVoucherCode');
            const selectedVoucherAmount = document.getElementById('selectedVoucherAmount');
            const selectedVoucherMinOrder = document.getElementById('selectedVoucherMinOrder');
            const removeVoucherBtn = document.getElementById('removeVoucherBtn');
            const voucherError = document.getElementById('voucherError');
            const voucherErrorMessage = document.getElementById('voucherErrorMessage');
            const discountRow = document.getElementById('discountRow');
            const discountAmount = document.getElementById('discountAmount');
            
            // Lấy giá trị đơn hàng
            const subtotalElement = document.getElementById('subtotal');
            const shippingFeeElement = document.getElementById('shippingFee');
            const finalTotalElement = document.getElementById('finalTotal');
            
            let subtotal = parseFloat(subtotalElement.getAttribute('data-value') || 0);
            let shippingFee = parseFloat(shippingFeeElement.getAttribute('data-value') || 30000);
            let discount = 0;
            
            // Format currency
            function formatCurrency(amount) {
                return new Intl.NumberFormat('vi-VN').format(amount) + ' ₫';
            }
            
            // Calculate and update the final total
            function updateTotalPrice() {
                const finalTotal = subtotal + shippingFee - discount;
                finalTotalElement.textContent = formatCurrency(finalTotal);
            }
            
            // Xử lý khi chọn voucher từ dropdown
            voucherSelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const voucherCode = this.value;
                
                // Nếu không chọn voucher nào
                if (!voucherCode) {
                    selectedVoucherDetails.classList.add('d-none');
                    voucherError.classList.add('d-none');
                    discountRow.classList.add('d-none');
                    discount = 0;
                    updateTotalPrice();
                    return;
                }
                
                // Lấy thông tin voucher từ option đã chọn
                const discountValue = parseFloat(selectedOption.getAttribute('data-discount') || 0);
                const minOrderValue = parseFloat(selectedOption.getAttribute('data-min-order') || 0);
                
                // Kiểm tra điều kiện áp dụng voucher
                if (subtotal < minOrderValue) {
                    voucherError.classList.remove('d-none');
                    voucherErrorMessage.textContent = `Đơn hàng không đủ điều kiện áp dụng mã giảm giá này (tối thiểu ${formatCurrency(minOrderValue)})`;
                    selectedVoucherDetails.classList.add('d-none');
                    discountRow.classList.add('d-none');
                    discount = 0;
                    updateTotalPrice();
                    
                    // Reset select về giá trị mặc định sau 3 giây
                    setTimeout(() => {
                        this.value = '';
                        voucherError.classList.add('d-none');
                    }, 3000);
                    
                    return;
                }
                
                // Hiển thị thông tin voucher đã chọn
                selectedVoucherCode.textContent = voucherCode;
                selectedVoucherAmount.textContent = formatCurrency(discountValue);
                selectedVoucherMinOrder.textContent = `Đơn tối thiểu: ${formatCurrency(minOrderValue)}`;
                selectedVoucherDetails.classList.remove('d-none');
                voucherError.classList.add('d-none');
                
                // Cập nhật giảm giá
                discount = discountValue;
                discountAmount.textContent = `-${formatCurrency(discount)}`;
                discountRow.classList.remove('d-none');
                
                // Cập nhật tổng tiền
                updateTotalPrice();
            });
            
            // Xử lý khi xóa voucher
            removeVoucherBtn.addEventListener('click', function() {
                voucherSelect.value = '';
                selectedVoucherDetails.classList.add('d-none');
                discountRow.classList.add('d-none');
                discount = 0;
                updateTotalPrice();
            });

            // Xử lý nút đặt hàng
            const placeOrderBtn = document.getElementById('placeOrderBtn');
            
            placeOrderBtn.addEventListener('click', function() {
                // Kiểm tra xem đã chọn địa chỉ mới hay không
                if (useNewAddress.checked) {
                    // Kiểm tra thông tin địa chỉ mới
                    const newName = document.getElementById('newName').value;
                    const newPhone = document.getElementById('newPhone').value;
                    const newProvince = provinceSelect.options[provinceSelect.selectedIndex]?.text;
                    const newDistrict = districtSelect.options[districtSelect.selectedIndex]?.text;
                    const newWard = wardSelect.options[wardSelect.selectedIndex]?.text;
                    const newAddressDetail = document.getElementById('newAddressDetail').value;
                    
                    if (!newName || !newPhone || !newProvince || !newDistrict || !newWard || !newAddressDetail) {
                        alert('Vui lòng điền đầy đủ thông tin địa chỉ mới');
                        return;
                    }
                }
                
                // Hiển thị trạng thái đang xử lý
                placeOrderBtn.disabled = true;
                placeOrderBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Đang xử lý...';
                
                // Lấy phương thức thanh toán đã chọn
                const selectedPaymentMethod = document.querySelector('input[name="paymentMethod"]:checked').id;
                
                // Tạo đối tượng chứa thông tin đơn hàng
                const orderData = {
                    useProfileAddress: useProfileAddress.checked,
                    paymentMethod: selectedPaymentMethod
                };
                
                // Thêm thông tin mã giảm giá nếu có
                if (voucherSelect.value) {
                    orderData.couponCode = voucherSelect.value;
                    orderData.discountAmount = discount;
                }
                
                if (useNewAddress.checked) {
                    orderData.newAddress = {
                        name: document.getElementById('newName').value,
                        phone: document.getElementById('newPhone').value,
                        province: provinceSelect.options[provinceSelect.selectedIndex].text,
                        district: districtSelect.options[districtSelect.selectedIndex].text,
                        ward: wardSelect.options[wardSelect.selectedIndex].text,
                        addressDetail: document.getElementById('newAddressDetail').value
                    };
                }
                
                // Gửi dữ liệu đơn hàng đến server
                fetch('/order/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(orderData)
                })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    }
                    throw new Error('Có lỗi xảy ra khi đặt hàng');
                })
                .then(data => {
                    // Xử lý dựa trên phương thức thanh toán
                    if (selectedPaymentMethod === 'momoPayment') {
                        // Chuyển hướng đến trang thanh toán MoMo - FIX: Sử dụng đúng đường dẫn và đảm bảo amount được truyền
                        const totalAmount = subtotal + shippingFee - discount;
                        window.location.href = '/momo-payment?orderId=' + data.orderId + '&amount=' + totalAmount;
                    } else {
                        // Chuyển hướng đến trang hoàn tất đơn hàng
                        window.location.href = '/order/complete?id=' + data.orderId;
                    }
                })
                .catch(error => {
                    console.error('Lỗi:', error);
                    alert('Có lỗi xảy ra khi đặt hàng. Vui lòng thử lại sau.');
                    
                    // Khôi phục trạng thái nút
                    placeOrderBtn.disabled = false;
                    placeOrderBtn.innerHTML = '<i class="fa-solid fa-check-circle me-2"></i>ĐẶT HÀNG';
                });
            });
        });
    </script>
</body>
</html>