<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{/Layout/Head}">
    <title>Thanh toán</title>
</head>
<head>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.css" rel="stylesheet">
    <style>
        .transition-all {
            transition: all 0.3s ease;
        }
    
        .transition-all:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1) !important;
        }
    
        .transition-hover {
            transition: all 0.2s ease;
        }
    
        .transition-hover:hover {
            transform: scale(1.02);
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
    
        .transition-btn {
            transition: all 0.3s ease;
        }
    
        .transition-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255,193,7,0.4);
            background-color: #ffca2c;
        }

        .checkout-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            position: relative;
        }

        .checkout-steps::before {
            content: '';
            position: absolute;
            top: 24px;
            left: 0;
            right: 0;
            height: 2px;
            background-color: #e9ecef;
            z-index: 1;
        }

        .step {
            position: relative;
            z-index: 2;
            background-color: white;
            padding: 0 15px;
            text-align: center;
        }

        .step-number {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #e9ecef;
            color: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .step.active .step-number {
            background-color: #ffc107;
            color: white;
        }

        .step.completed .step-number {
            background-color: #28a745;
            color: white;
        }

        .payment-method {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .payment-method:hover {
            border-color: #ffc107;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        .payment-method.selected {
            border-color: #ffc107;
            background-color: rgba(255, 193, 7, 0.1);
        }

        .address-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .address-card:hover {
            border-color: #ffc107;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        .address-card.selected {
            border-color: #ffc107;
            background-color: rgba(255, 193, 7, 0.1);
        }

        .order-summary-item {
            display: flex;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #f1f1f1;
        }

        .order-summary-item:last-child {
            border-bottom: none;
        }

        .item-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            margin-right: 15px;
        }

        .item-details {
            flex: 1;
        }

        .item-price {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .item-quantity {
            font-size: 0.9rem;
            color: #6c757d;
        }

        .item-total {
            font-weight: bold;
            color: #212529;
        }

        .form-check-input:checked {
            background-color: #ffc107;
            border-color: #ffc107;
        }
        
        /* CSS cho phần mã giảm giá */
        .coupon-section {
            margin-top: 15px;
            margin-bottom: 15px;
        }
        
        .coupon-input {
            display: flex;
            margin-bottom: 10px;
        }
        
        .coupon-success {
            background-color: rgba(40, 167, 69, 0.1);
            border-radius: 5px;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            margin-top: 10px;
        }
        
        .coupon-error {
            background-color: rgba(220, 53, 69, 0.1);
            border-radius: 5px;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            margin-top: 10px;
        }
        
        .btn-apply-coupon {
            background-color: #ffc107;
            color: #212529;
            border: none;
            transition: all 0.3s;
        }
        
        .btn-apply-coupon:hover {
            background-color: #ffca2c;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255,193,7,0.4);
        }
        
        .btn-remove-coupon {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            margin-left: auto;
            padding: 0;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div th:replace="~{/Layout/Navbar}"></div>

    <div class="container-fluid py-5 mt-5 pt-5">
        <!-- Login Required Message -->
        <div class="row" th:if="${loginMessage != null}">
            <div class="col-12">
                <div class="alert alert-warning text-center">
                    <i class="fa-solid fa-circle-exclamation me-2"></i>
                    <span th:text="${loginMessage}">Vui lòng đăng nhập để tiếp tục thanh toán</span>
                    <a th:href="@{/login}" class="btn btn-sm btn-primary ms-3">Đăng nhập ngay</a>
                </div>
            </div>
        </div>

        <!-- Checkout Content - Only show if user is logged in -->
        <div class="row" th:if="${loginMessage == null}">
            <div class="col-12 mb-4">
                <div class="checkout-steps">
                    <div class="step completed">
                        <div class="step-number">1</div>
                        <div class="step-title">Giỏ hàng</div>
                    </div>
                    <div class="step active">
                        <div class="step-number">2</div>
                        <div class="step-title">Thanh toán</div>
                    </div>
                    <div class="step">
                        <div class="step-number">3</div>
                        <div class="step-title">Hoàn tất</div>
                    </div>
                </div>
            </div>

            <div class="col-lg-8 col-12 pe-lg-4">
                <!-- Shipping Address Section -->
                <div class="border border-1 p-4 rounded-3 mb-4 bg-white shadow-sm">
                    <h5 class="fw-bold mb-3">
                        <i class="fa-solid fa-location-dot me-2 text-warning"></i>
                        Địa chỉ giao hàng
                    </h5>

                    <div class="mb-3">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" name="addressOption" id="useProfileAddress" checked>
                            <label class="form-check-label" for="useProfileAddress">
                                Sử dụng địa chỉ từ hồ sơ
                            </label>
                        </div>
                        
                        <div id="profileAddressCard" class="address-card selected ms-4">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="mb-1" th:text="${fullname}">Tên người dùng</h6>
                                    <p class="mb-1" th:text="${phone}">Số điện thoại</p>
                                    <p class="mb-0 text-muted" th:text="${address} + ', ' + ${ward} + ', ' + ${district} + ', ' + ${province}">
                                        Địa chỉ chi tiết, Phường/Xã, Quận/Huyện, Tỉnh/Thành phố
                                    </p>
                                </div>
                                <div>
                                    <span class="badge bg-success">Mặc định</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" name="addressOption" id="useNewAddress">
                            <label class="form-check-label" for="useNewAddress">
                                Sử dụng địa chỉ mới
                            </label>
                        </div>
                        
                        <div id="newAddressForm" class="ms-4 d-none">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Họ và tên</label>
                                    <input type="text" class="form-control" id="newName" placeholder="Nhập họ và tên">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Số điện thoại</label>
                                    <input type="tel" class="form-control" id="newPhone" placeholder="Nhập số điện thoại">
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label class="form-label">Tỉnh/Thành phố</label>
                                    <select class="form-select" id="newProvince">
                                        <option value="">Chọn tỉnh/thành phố</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Quận/Huyện</label>
                                    <select class="form-select" id="newDistrict">
                                        <option value="">Chọn quận/huyện</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Phường/Xã</label>
                                    <select class="form-select" id="newWard">
                                        <option value="">Chọn phường/xã</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Địa chỉ chi tiết</label>
                                <input type="text" class="form-control" id="newAddressDetail" placeholder="Số nhà, tên đường, khu vực...">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payment Method Section -->
                <div class="border border-1 p-4 rounded-3 mb-4 bg-white shadow-sm">
                    <h5 class="fw-bold mb-3">
                        <i class="fa-solid fa-credit-card me-2 text-warning"></i>
                        Phương thức thanh toán
                    </h5>

                    <div class="payment-method selected" data-method="codPayment">
                        <div class="d-flex align-items-center">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="codPayment" checked>
                                <label class="form-check-label" for="codPayment">
                                    <strong>Thanh toán khi nhận hàng (COD)</strong>
                                </label>
                            </div>
                            <div class="ms-auto">
                                <i class="fa-solid fa-money-bill-wave fa-lg text-success"></i>
                            </div>
                        </div>
                        <div class="ms-4 mt-2 text-muted small">
                            Bạn sẽ thanh toán bằng tiền mặt khi nhận hàng
                        </div>
                    </div>

                    <div class="payment-method mt-3" data-method="bankPayment">
                        <div class="d-flex align-items-center">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="bankPayment">
                                <label class="form-check-label" for="bankPayment">
                                    <strong>Chuyển khoản ngân hàng</strong>
                                </label>
                            </div>
                            <div class="ms-auto">
                                <i class="fa-solid fa-building-columns fa-lg text-primary"></i>
                            </div>
                        </div>
                        <div class="ms-4 mt-2 text-muted small">
                            Thực hiện thanh toán vào ngay tài khoản ngân hàng của chúng tôi. Vui lòng sử dụng Mã đơn hàng của bạn trong phần Nội dung thanh toán. Đơn hàng sẽ đươc giao sau khi tiền đã chuyển.
                        </div>
                    </div>

                    <div class="payment-method mt-3" data-method="momoPayment">
                        <div class="d-flex align-items-center">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="momoPayment">
                                <label class="form-check-label" for="momoPayment">
                                    <strong>Thanh toán MoMo</strong>
                                </label>
                            </div>
                            <div class="ms-auto">
                                <i class="fa-solid fa-wallet fa-lg text-danger"></i>
                            </div>
                        </div>
                        <div class="ms-4 mt-2 text-muted small">
                            Thanh toán qua ví điện tử MoMo
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4 col-12">
                <!-- Order Summary -->
                <div class="border shadow-sm p-4 rounded-3 bg-light transition-all">
                    <h5 class="fw-bold mb-4 text-success position-relative">
                        THÔNG TIN ĐƠN HÀNG
                        <span class="position-absolute bottom-0 start-0 bg-success h-1 w-25 rounded"></span>
                    </h5>
                    
                    <div class="order-items mb-3">
                        <!-- Hiển thị các sản phẩm trong giỏ hàng -->
                        <div th:each="item : ${cartItems}" class="order-summary-item">
                            <img th:src="${item.image}" alt="Product Image" class="item-image">
                            <div class="item-details">
                                <h6 class="mb-1" th:text="${item.name}">Tên sản phẩm</h6>
                                <div class="item-price mb-1" th:text="${#numbers.formatDecimal(item.price, 0, 'COMMA', 0, 'POINT')} + ' ₫'">Giá</div>
                                <div class="d-flex justify-content-between">
                                    <span class="item-quantity" th:text="'SL: ' + ${item.quantity}">SL: 1</span>
                                    <span class="item-total" th:text="${#numbers.formatDecimal(item.totalPrice, 0, 'COMMA', 0, 'POINT')} + ' ₫'">Tổng</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="border-top pt-3 mt-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">Tạm tính</span>
                            <span id="subtotal" class="fw-semibold" th:text="${#numbers.formatDecimal(totalPrice, 0, 'COMMA', 0, 'POINT')} + ' ₫'">0 ₫</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">Phí vận chuyển</span>
                            <span id="shippingFee" class="fw-semibold">30,000 ₫</span>
                        </div>
                        
                        <!-- Phần mã giảm giá -->
                        <div class="coupon-section">
                            <div class="coupon-input">
                                <input type="text" class="form-control me-2" id="couponCode" placeholder="Nhập mã giảm giá">
                                <button class="btn btn-apply-coupon" id="applyCouponBtn">Áp dụng</button>
                            </div>
                            
                            <!-- Hiển thị khi áp dụng mã giảm giá thành công -->
                            <div class="coupon-success d-none" id="couponSuccess">
                                <i class="fa-solid fa-check-circle text-success me-2"></i>
                                <span>Đã áp dụng mã: <strong id="appliedCouponCode">WELCOME10</strong></span>
                                <button class="btn-remove-coupon" id="removeCouponBtn">
                                    <i class="fa-solid fa-times"></i>
                                </button>
                            </div>
                            
                            <!-- Hiển thị khi mã giảm giá không hợp lệ -->
                            <div class="coupon-error d-none" id="couponError">
                                <i class="fa-solid fa-exclamation-circle text-danger me-2"></i>
                                <span>Mã giảm giá không hợp lệ hoặc đã hết hạn</span>
                            </div>
                        </div>
                        
                        <!-- Hiển thị giảm giá khi áp dụng mã giảm giá thành công -->
                        <div class="d-flex justify-content-between mb-2 d-none" id="discountRow">
                            <span class="text-muted">Giảm giá</span>
                            <span id="discountAmount" class="fw-semibold text-danger">-10,000 ₫</span>
                        </div>
                        
                        <h6 class="d-flex justify-content-between fw-bold mt-3 mb-4 text-dark">
                            <span>Tổng cộng</span>
                            <span id="finalTotal" class="text-success" th:with="total=${totalPrice + 30000}" th:text="${#numbers.formatDecimal(total, 0, 'COMMA', 0, 'POINT')} + ' ₫'">0 ₫</span>
                        </h6>
                    </div>
            
                    <button id="placeOrderBtn" class="btn btn-warning w-100 mt-2 rounded-pill py-2 fw-semibold transition-btn">
                        <i class="fa-solid fa-check-circle me-2"></i>
                        ĐẶT HÀNG
                    </button>

                    <div class="text-center mt-3">
                        <a href="/yourcart" class="text-decoration-none">
                            <i class="fa-solid fa-arrow-left me-1"></i>
                            Quay lại giỏ hàng
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div th:replace="~{/Layout/Footer}"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.js"></script>
    <script>AOS.init();</script>

    <script th:inline="javascript">
        document.addEventListener("DOMContentLoaded", function() {
            // Xử lý chọn địa chỉ
            const useProfileAddress = document.getElementById('useProfileAddress');
            const useNewAddress = document.getElementById('useNewAddress');
            const profileAddressCard = document.getElementById('profileAddressCard');
            const newAddressForm = document.getElementById('newAddressForm');

            useProfileAddress.addEventListener('change', function() {
                if (this.checked) {
                    profileAddressCard.classList.add('selected');
                    newAddressForm.classList.add('d-none');
                }
            });

            useNewAddress.addEventListener('change', function() {
                if (this.checked) {
                    profileAddressCard.classList.remove('selected');
                    newAddressForm.classList.remove('d-none');
                }
            });

            // Xử lý chọn phương thức thanh toán
            const paymentMethods = document.querySelectorAll('.payment-method');
            const paymentRadios = document.querySelectorAll('input[name="paymentMethod"]');

            paymentMethods.forEach(method => {
                method.addEventListener('click', function() {
                    // Bỏ chọn tất cả
                    paymentMethods.forEach(m => m.classList.remove('selected'));
                    
                    // Chọn phương thức hiện tại
                    this.classList.add('selected');
                    
                    // Chọn radio button tương ứng
                    const methodType = this.getAttribute('data-method');
                    document.getElementById(methodType).checked = true;
                });
            });

            paymentRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.checked) {
                        // Bỏ chọn tất cả
                        paymentMethods.forEach(m => m.classList.remove('selected'));
                        
                        // Chọn phương thức tương ứng
                        const methodId = this.id;
                        document.querySelector(`.payment-method[data-method="${methodId}"]`).classList.add('selected');
                    }
                });
            });

            // Xử lý API địa chỉ cho form địa chỉ mới
            const provinceSelect = document.getElementById("newProvince");
            const districtSelect = document.getElementById("newDistrict");
            const wardSelect = document.getElementById("newWard");

            // Lấy danh sách tỉnh/thành phố từ API
            fetch("https://provinces.open-api.vn/api/p/")
                .then(response => response.json())
                .then(data => {
                    // Thêm các tùy chọn vào dropdown tỉnh/thành phố
                    data.forEach(province => {
                        let option = document.createElement("option");
                        option.value = province.code;
                        option.textContent = province.name;
                        provinceSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error("Lỗi khi lấy danh sách tỉnh/thành phố:", error);
                });

            // Hàm tải danh sách quận/huyện
            function loadDistricts(provinceCode) {
                fetch(`https://provinces.open-api.vn/api/p/${provinceCode}?depth=2`)
                    .then(response => response.json())
                    .then(data => {
                        // Xóa các tùy chọn hiện tại
                        districtSelect.innerHTML = "<option value=''>Chọn quận/huyện</option>";
                        
                        // Thêm các tùy chọn mới
                        data.districts.forEach(district => {
                            let option = document.createElement("option");
                            option.value = district.code;
                            option.textContent = district.name;
                            districtSelect.appendChild(option);
                        });
                    })
                    .catch(error => {
                        console.error("Lỗi khi lấy danh sách quận/huyện:", error);
                    });
            }
            
            // Hàm tải danh sách phường/xã
            function loadWards(districtCode) {
                fetch(`https://provinces.open-api.vn/api/d/${districtCode}?depth=2`)
                    .then(response => response.json())
                    .then(data => {
                        // Xóa các tùy chọn hiện tại
                        wardSelect.innerHTML = "<option value=''>Chọn phường/xã</option>";
                        
                        // Thêm các tùy chọn mới
                        data.wards.forEach(ward => {
                            let option = document.createElement("option");
                            option.value = ward.code;
                            option.textContent = ward.name;
                            wardSelect.appendChild(option);
                        });
                    })
                    .catch(error => {
                        console.error("Lỗi khi lấy danh sách phường/xã:", error);
                    });
            }

            // Sự kiện khi chọn tỉnh/thành phố
            provinceSelect.addEventListener("change", function() {
                const provinceCode = this.value;
                
                // Xóa các tùy chọn quận/huyện và phường/xã
                districtSelect.innerHTML = "<option value=''>Chọn quận/huyện</option>";
                wardSelect.innerHTML = "<option value=''>Chọn phường/xã</option>";
                
                // Nếu đã chọn tỉnh/thành phố, tải danh sách quận/huyện
                if (provinceCode) {
                    loadDistricts(provinceCode);
                }
            });
            
            // Sự kiện khi chọn quận/huyện
            districtSelect.addEventListener("change", function() {
                const districtCode = this.value;
                
                // Xóa các tùy chọn phường/xã
                wardSelect.innerHTML = "<option value=''>Chọn phường/xã</option>";
                
                // Nếu đã chọn quận/huyện, tải danh sách phường/xã
                if (districtCode) {
                    loadWards(districtCode);
                }
            });
            
            // Xử lý mã giảm giá
            const applyCouponBtn = document.getElementById('applyCouponBtn');
            const removeCouponBtn = document.getElementById('removeCouponBtn');
            const couponSuccess = document.getElementById('couponSuccess');
            const couponError = document.getElementById('couponError');
            const discountRow = document.getElementById('discountRow');
            const couponCodeInput = document.getElementById('couponCode');
            const appliedCouponCode = document.getElementById('appliedCouponCode');
            
            // Xử lý khi nhấn nút áp dụng mã giảm giá
            applyCouponBtn.addEventListener('click', function() {
                const couponCode = couponCodeInput.value.trim();
                
                if (couponCode) {
                    // Giả lập kiểm tra mã giảm giá (chỉ UI, không có logic thực)
                    if (couponCode.toUpperCase() === 'WELCOME10' || couponCode.toUpperCase() === 'SALE20') {
                        // Hiển thị thông báo áp dụng thành công
                        couponSuccess.classList.remove('d-none');
                        couponError.classList.add('d-none');
                        discountRow.classList.remove('d-none');
                        appliedCouponCode.textContent = couponCode.toUpperCase();
                        
                        // Xóa giá trị input
                        couponCodeInput.value = '';
                        
                        // Trong thực tế, cần tính toán lại tổng tiền dựa trên giá trị giảm giá
                    } else {
                        // Hiển thị thông báo lỗi
                        couponSuccess.classList.add('d-none');
                        couponError.classList.remove('d-none');
                        discountRow.classList.add('d-none');
                    }
                }
            });
            
            // Xử lý khi nhấn nút xóa mã giảm giá
            removeCouponBtn.addEventListener('click', function() {
                couponSuccess.classList.add('d-none');
                discountRow.classList.add('d-none');
                couponCodeInput.value = '';
                
                // Trong thực tế, cần tính toán lại tổng tiền khi xóa giảm giá
            });
            
            // Xử lý khi nhấn Enter trong input mã giảm giá
            couponCodeInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    applyCouponBtn.click();
                }
            });

            // Xử lý nút đặt hàng
            const placeOrderBtn = document.getElementById('placeOrderBtn');
            
            placeOrderBtn.addEventListener('click', function() {
                // Kiểm tra xem đã chọn địa chỉ mới hay không
                if (useNewAddress.checked) {
                    // Kiểm tra thông tin địa chỉ mới
                    const newName = document.getElementById('newName').value;
                    const newPhone = document.getElementById('newPhone').value;
                    const newProvince = provinceSelect.options[provinceSelect.selectedIndex]?.text;
                    const newDistrict = districtSelect.options[districtSelect.selectedIndex]?.text;
                    const newWard = wardSelect.options[wardSelect.selectedIndex]?.text;
                    const newAddressDetail = document.getElementById('newAddressDetail').value;
                    
                    if (!newName || !newPhone || !newProvince || !newDistrict || !newWard || !newAddressDetail) {
                        alert('Vui lòng điền đầy đủ thông tin địa chỉ mới');
                        return;
                    }
                }
                
                // Hiển thị trạng thái đang xử lý
                placeOrderBtn.disabled = true;
                placeOrderBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Đang xử lý...';
                
                // Lấy phương thức thanh toán đã chọn
                const selectedPaymentMethod = document.querySelector('input[name="paymentMethod"]:checked').id;
                
                // Tạo đối tượng chứa thông tin đơn hàng
                const orderData = {
                    useProfileAddress: useProfileAddress.checked,
                    paymentMethod: selectedPaymentMethod
                };
                
                // Thêm thông tin mã giảm giá nếu có
                if (!couponSuccess.classList.contains('d-none')) {
                    orderData.couponCode = appliedCouponCode.textContent;
                }
                
                if (useNewAddress.checked) {
                    orderData.newAddress = {
                        name: document.getElementById('newName').value,
                        phone: document.getElementById('newPhone').value,
                        province: provinceSelect.options[provinceSelect.selectedIndex].text,
                        district: districtSelect.options[districtSelect.selectedIndex].text,
                        ward: wardSelect.options[wardSelect.selectedIndex].text,
                        addressDetail: document.getElementById('newAddressDetail').value
                    };
                }
                
                // Gửi dữ liệu đơn hàng đến server
                fetch('/order/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(orderData)
                })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    }
                    throw new Error('Có lỗi xảy ra khi đặt hàng');
                })
                .then(data => {
                    // Chuyển hướng đến trang hoàn tất đơn hàng
                    window.location.href = '/order/complete?id=' + data.orderId;
                })
                .catch(error => {
                    console.error('Lỗi:', error);
                    alert('Có lỗi xảy ra khi đặt hàng. Vui lòng thử lại sau.');
                    
                    // Khôi phục trạng thái nút
                    placeOrderBtn.disabled = false;
                    placeOrderBtn.innerHTML = '<i class="fa-solid fa-check-circle me-2"></i>ĐẶT HÀNG';
                });
            });
        });
    </script>
</body>
</html>

